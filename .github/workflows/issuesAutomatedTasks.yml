name: Issue Templates automated Tasks
on:
    issues:
      types: [opened, edited]
  
jobs:
    check_issue:
      runs-on: ubuntu-latest
      outputs:
        issue_template: ${{ steps.template.outputs.issue_template }}
        issue_json: ${{ steps.parse-issue.outputs.json }}
      steps:
        - id: template
          run: |
            if [[ "${{ github.event.issue.title }}" == "[ADD_GAME]*" ]]; then
                echo "issue_template=ADD_GAME" >> $GITHUB_OUTPUT
            elif [[ "${{ github.event.issue.title }}" == "[UPDATE_GAME]*" ]]; then
                echo "issue_template=UPDATE_GAME" >> $GITHUB_OUTPUT
            elif [[ "${{ github.event.issue.title }}" == "[DELETE_GAME]*" ]]; then
                echo "issue_template=DELETE_GAME" >> $GITHUB_OUTPUT
            elif [[ "${{ github.event.issue.title }}" == "[ADD_BACKLOG]*" ]]; then
                echo "issue_template=ADD_BACKLOG" >> $GITHUB_OUTPUT
            elif [[ "${{ github.event.issue.title }}" == "[DELETE_BACKLOG]*" ]]; then
                echo "issue_template=DELETE_BACKLOG" >> $GITHUB_OUTPUT
            else
                echo "issue_template=UNKNOWN" >> $GITHUB_OUTPUT
            fi
        - id: parse-issue
          name: Parse Issue
          uses: GrantBirki/issue-template-parser@v7.0.3
    magic_time:
        needs: check_issue
        runs-on: ubuntu-latest
        if: ${{ needs.check_issue.outputs.issue_template != 'UNKNOWN' }}
        permissions:
            contents: write
            pull-requests: write
        steps:
          - name: 🛎️ Checkout
            uses: actions/checkout@v4
          - name: Setup Node.js ✨
            uses: actions/setup-node@v4.0.2
            with:
                node-version: "lts/*"
          - name: 💻 Install npm packages
            run: npm install better-sqlite3 --no-save
          - name: Run Node.js program
            env:
              TEMPLATE: ${{ needs.check_issue.outputs.issue_template }}
              REQUEST: ${{ needs.check_issue.outputs.issue_json }}
            run: |
                node automatedTasks.mjs "$TEMPLATE" "$REQUEST"
          - name: 🤖 Update JSON files after this change
            run: npm run generate-api-json-files
          - name: 💅 Create Pull Request
            uses: peter-evans/create-pull-request@v6
            with:
              title: "🤖 [Automated Task] Workflow: ${{ needs.check_issue.outputs.issue_template }}"
              body: |
                ### Automated Change Details

                The following changes were made to the JSON files based on the issue template :

                ```json  
                ${{ toJson(fromJson(needs.check_issue.outputs.issue_json)) }}
                ```

                Please review the changes.