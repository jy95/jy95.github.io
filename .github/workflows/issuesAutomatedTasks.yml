name: Issue Templates automated Tasks
on:
    issues:
      types: [opened, edited]
  
jobs:
    check_issue:
      runs-on: ubuntu-latest
      outputs:
        issue_type: ${{ steps.detect_issue_type.outputs.issue_type }}
        template_file: ${{ steps.set_template_file.outputs.template_file }}
        issue_json: ${{ steps.parse-issue.outputs.json }}
      steps:
        - id: detect_issue_type
          run: |
            issue_title="${{ github.event.issue.title }}"
            
            if [[ "$issue_title" =~ ^\[ADD_GAME\] ]]; then
                echo "issue_type=ADD_GAME" >> $GITHUB_OUTPUT
            elif [[ "$issue_title" =~ ^\[UPDATE_GAME\] ]]; then
                echo "issue_type=UPDATE_GAME" >> $GITHUB_OUTPUT
            elif [[ "$issue_title" =~ ^\[DELETE_GAME\] ]]; then
                echo "issue_type=DELETE_GAME" >> $GITHUB_OUTPUT
            elif [[ "$issue_title" =~ ^\[ADD_BACKLOG\] ]]; then
                echo "issue_type=ADD_BACKLOG" >> $GITHUB_OUTPUT
            elif [[ "$issue_title" =~ ^\[DELETE_BACKLOG\] ]]; then
                echo "issue_type=DELETE_BACKLOG" >> $GITHUB_OUTPUT
            else
                echo "issue_type=UNKNOWN" >> $GITHUB_OUTPUT
            fi
        - id: set_template_file
          run: |
            case "${{ steps.detect_issue_type.outputs.issue_type }}" in
              ADD_GAME)
                echo "template_file=01-add-game.yml" >> $GITHUB_OUTPUT
                ;;
              UPDATE_GAME)
                echo "template_file=02-update-game.yml" >> $GITHUB_OUTPUT
                ;;
              DELETE_GAME)
                echo "template_file=03-delete-game.yml" >> $GITHUB_OUTPUT
                ;;
              ADD_BACKLOG)
                echo "template_file=04-add-backlog.yml" >> $GITHUB_OUTPUT
                ;;
              DELETE_BACKLOG)
                echo "template_file=05-delete-backlog.yml" >> $GITHUB_OUTPUT
                ;;
            esac
        - id: parse-issue
          name: IssueOps Form Parser
          uses: issue-ops/parser@v2.0.0
          if: ${{ steps.detect_issue_type.outputs.issue_type != 'UNKNOWN' }}
          with:
            issue-form-template: ${{ steps.set_template_file.outputs.template_file }}
            body: ${{ github.event.issue.body }}

    magic_time:
        needs: check_issue
        runs-on: ubuntu-latest
        if: ${{ needs.check_issue.outputs.issue_type != 'UNKNOWN' }}
        permissions:
            contents: write
            pull-requests: write
        steps:
          - name: 🛎️ Checkout
            uses: actions/checkout@v4
          - name: Setup Node.js ✨
            uses: actions/setup-node@v4.0.2
            with:
                node-version: "lts/*"
          - name: 💻 Install npm packages
            run: npm install better-sqlite3 --no-save
          - name: Run Node.js program
            env:
              TEMPLATE: ${{ needs.check_issue.outputs.issue_type }}
              REQUEST: ${{ needs.check_issue.outputs.issue_json }}
            run: |
                node automatedTasks.mjs "$TEMPLATE" "$REQUEST"
          - name: 🤖 Update JSON files after this change
            run: npm run generate-api-json-files
          - name: 💅 Create Pull Request
            uses: peter-evans/create-pull-request@v6
            with:
              title: "🤖 [Automated Task] Workflow: ${{ needs.check_issue.outputs.issue_type }}"
              body: |
                ### Automated Change Details

                The following changes were made to the JSON files based on the issue template :

                ```json  
                ${{ toJson(fromJson(needs.check_issue.outputs.issue_json)) }}
                ```

                Please review the changes.